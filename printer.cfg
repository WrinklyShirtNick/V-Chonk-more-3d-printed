#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
### Everything below [include RatOS.cfg] will override default RatOS behavior
#############################################################################################################
[include RatOS.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_homing_z_hop: 5
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_adaptive_mesh: True
variable_end_print_park_z_hop: 5
variable_skew_profile: "my_skew"

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-z-offset
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

[ratos]
allow_unsupported_slicer_versions: True
bypass_post_processing: True


[printer]
max_velocity: 400
max_accel: 10000


[input_shaper]
shaper_freq_x: 49.8
shaper_type_x: mzv
shaper_freq_y: 75.7
shaper_type_y: mzv

[gcode_macro RatOS]
variable_macro_travel_speed: 300
variable_macro_travel_accel: 3000

#############################################################################################################
### CONTROLBOARD & TOOLBOARD
#############################################################################################################
[include RatOS/boards/rpi/config.cfg]
[board_pins btt-octopus-11]
aliases:
	#----------------------------------------------- X motor pins -----------------------------------------------
	# Assigned to slot: "MOTOR 0"
	#------------------------------------------------------------------------------------------------------------
	x_step_pin=PF13,
	x_dir_pin=PF12,
	x_enable_pin=PF14,
	x_uart_pin=PC4,
	x_diag_pin=PG6,
	x_endstop_pin=PG6,
	#----------------------------------------------- Y motor pins -----------------------------------------------
	# Assigned to slot: "MOTOR 1"
	#------------------------------------------------------------------------------------------------------------
	y_step_pin=PG0,
	y_dir_pin=PG1,
	y_enable_pin=PF15,
	y_uart_pin=PD11,
	y_diag_pin=PG9,
	y_endstop_pin=PG9,
	#----------------------------------------------- Z motor pins -----------------------------------------------
	# Assigned to slot: "MOTOR 5"
	#------------------------------------------------------------------------------------------------------------
	z0_step_pin=PC13,
	z0_dir_pin=PF0,
	z0_enable_pin=PF1,
	z0_uart_pin=PE4,
	z0_diag_pin=PG13,
	#---------------------------------------------- Z1 motor pins -----------------------------------------------
	# Assigned to slot: "MOTOR 6"
	#------------------------------------------------------------------------------------------------------------
	z1_step_pin=PE2,
	z1_dir_pin=PE3,
	z1_enable_pin=PD4,
	z1_uart_pin=PE1,
	z1_diag_pin=PG14,
    #---------------------------------------------- Z2 motor pins -----------------------------------------------
	# Assigned to slot: "MOTOR 7"
	#------------------------------------------------------------------------------------------------------------
	z2_step_pin=PE6,
	z2_dir_pin=PA14,
	z2_enable_pin=PE0,
	z2_uart_pin=PD3,
	z2_diag_pin=PG15,
	#------------------------------------------- EXTRUDER motor pins --------------------------------------------
	# Assigned to slot: "MOTOR 2"
	#------------------------------------------------------------------------------------------------------------
	e_step_pin=PF11,
	e_dir_pin=PG3,
	e_enable_pin=PG5,
	e_uart_pin=PC6,
	e_diag_pin=PG10,
	#----------------------------------------------- GENERAL PINS -----------------------------------------------
	e_heater_pin=PA2,
	e_sensor_pin=PF4,
	stepper_spi_mosi_pin=PA7,
	stepper_spi_miso_pin=PA6,
	stepper_spi_sclk_pin=PA5,
	adxl345_cs_pin=PA15,
	bltouch_sensor_pin=PB7,
	bltouch_control_pin=PB6,
	probe_pin=PB7,
	fan_part_cooling_pin=PA8,
	fan_toolhead_cooling_pin=PE5,
	fan_controller_board_pin=PD12,
	heater_bed_heating_pin=PA1,
	heater_bed_sensor_pin=PF3,
	4p_fan_part_cooling_pin=null,
	4p_fan_part_cooling_tach_pin=null,
	4p_toolhead_cooling_pin=null,
	4p_toolhead_cooling_tach_pin=null,
	4p_controller_board_pin=null,
	4p_controller_board_tach_pin=null
[mcu]
serial: /dev/RatOS/btt-octopus-11

[temperature_sensor Octopus_V1.1_F446]
sensor_type: temperature_mcu

[adxl345 controlboard]
cs_pin: PA15
spi_bus: spi3
#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
# Connected to MOTOR 7 on BIGTREETECH Octopus V1.1 F446
# Driver: BTT TMC2209 v1.3
# Motor: LDO-42STH48-2504AC
# Voltage: 24
#------------------------------------------------------------------------------------------------------------
[tmc2209 stepper_z2]
stealthchop_threshold: 0
interpolate: False
uart_pin: PD3
run_current: 0.85
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 2
driver_HSTRT: 0
sense_resistor: 0.11

[stepper_z2]
step_pin: PE6
dir_pin: PA14
enable_pin: !PE0
microsteps: 64
full_steps_per_rotation: 400
rotation_distance: 4

[z_tilt]
z_positions:
    -70, 90
    90, 250
    250, 90
points:
    45, 20
    110, 170
    175, 20
speed: 200
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
retries: 10
#   Number of times to retry if the probed points aren't within
#   tolerance.
retry_tolerance: .01
#   If retries are enabled then retry if largest and smallest probed
#   points differ more than retry_tolerance. Note the smallest unit of
#   change here would be a single step. However if you are probing
#   more points than steppers then you will likely have a fixed
#   minimum value for the range of probed points which you can learn
#   by observing command output.

#---------------------------------------------------- X -----------------------------------------------------
# The A axis motor for the toolhead, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: x_dir_pin       # Remove ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 20
position_min: 0
position_max: 180
position_endstop: 180

#---------------------------------------------------- Y -----------------------------------------------------
# The B axis motor for the toolhead, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: y_dir_pin       # Remove ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 20
position_min: -15
position_max: 180
position_endstop: 180

#---------------------------------------------------- Z -----------------------------------------------------
# The front right and left Z motors for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4      # 4 for TR8*4 lead screws
homing_speed: 8
position_min: -5
position_max: 180

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: !z1_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4      # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: !z2_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4      # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: e_dir_pin       # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 5.57   # Bondtech LGX Lite default
#pressure_advance: 0.05   # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300


[heater_bed]
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114

[fan]
pin: !fan_part_cooling_pin
cycle_time: 0.00004

[filament_switch_sensor RUNOUT]
pause_on_runout: True
runout_gcode: UNLOAD_FILAMENT
insert_gcode: 
event_delay:1.0
pause_delay:0.5
switch_pin: !PG10



# Probe configuration
[probe]
#z_offset: 0.0 # Will be commented out after a successful PROBE_CALIBRATE and SAVE_CONFIG
pin: ^probe_pin# For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.
#pin: ^!probe_pin # NPN NO (refer to the specs of your probe)
#pin: probe_pin # PNP NO (refer to the specs of your probe)
#pin: !probe_pin # PNP NC (refer to the specs of your probe)

# REMEMBER TO TUNE SENSORLESS HOMING BEFORE ATTEMPTING TO PRINT!
# You'll find instructions in the generated sensorless-homing-*.cfg file(s),
# where you should keep your sensorless homing settings.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 2.375
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.722
#*# pid_ki = 1.788
#*# pid_kd = 65.982
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 61.214
#*# pid_ki = 2.599
#*# pid_kd = 360.400
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.160312, 0.145469, 0.106250, 0.099062, 0.103281, 0.085156, 0.079062
#*# 	0.068437, 0.049219, 0.051250, 0.042187, 0.052656, 0.050937, 0.046719
#*# 	0.028594, 0.008906, 0.000937, 0.011406, 0.021875, 0.030937, 0.041406
#*# 	-0.014531, -0.025938, -0.021875, -0.001094, 0.017656, 0.026406, 0.029844
#*# 	-0.016719, -0.019063, -0.012344, 0.001719, 0.026406, 0.032187, 0.033437
#*# 	-0.032656, -0.016719, 0.004062, 0.020156, 0.040937, 0.095000, 0.063750
#*# 	0.017031, 0.032344, 0.056250, 0.083906, 0.102187, 0.118437, 0.138594
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 7.0
#*# max_x = 145.0
#*# min_y = 7.0
#*# max_y = 149.98
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	  0.157812, 0.129687, 0.133437, 0.141562, 0.146562, 0.157187, 0.145469
#*# 	  0.038281, 0.030469, 0.044687, 0.069844, 0.067656, 0.097031, 0.106562
#*# 	  -0.025781, -0.020000, 0.004844, 0.028281, 0.042656, 0.079375, 0.089844
#*# 	  -0.063594, -0.055313, -0.015469, 0.022969, 0.050469, 0.095312, 0.111094
#*# 	  -0.055313, -0.031094, 0.010469, 0.052187, 0.084062, 0.146562, 0.152344
#*# 	  -0.005469, 0.025000, 0.072812, 0.122500, 0.159687, 0.219062, 0.267812
#*# x_count = 7
#*# y_count = 6
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 7.0
#*# max_x = 145.0
#*# min_y = 15.3
#*# max_y = 150.0
#*#
#*# [skew_correction my_skew]
#*# xy_skew = -0.0016263056696063747
#*# xz_skew = 0.0
#*# yz_skew = 0.0
